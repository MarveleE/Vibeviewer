# Fastlane configuration for Vibeviewer

default_platform(:mac)

platform :mac do
  # ä» Project.swift è¯»å–ç‰ˆæœ¬å·
  def get_version_from_project
    project_file = File.join(Dir.pwd, "Project.swift")
    if File.exist?(project_file)
      content = File.read(project_file)
      if match = content.match(/let appVersion\s*=\s*"([0-9]+\.[0-9]+\.[0-9]+)"/)
        return match[1]
      end
    end
    UI.user_error!("Could not find version in Project.swift")
  end

  # è·å– GitHub ä»“åº“ä¿¡æ¯
  def get_github_repo
    ENV["GITHUB_REPO"] || "MarveleE/Vibeviewer"
  end

  # Debug Lane: æ„å»º Debug ç‰ˆæœ¬å¹¶åˆ›å»º DMG
  lane :debug do
    UI.header("Building Debug version")
    
    # ä½¿ç”¨ gym æ„å»ºåº”ç”¨
    gym(
      workspace: "Vibeviewer.xcworkspace",
      scheme: "Vibeviewer",
      configuration: "Debug",
      export_method: "development",
      output_directory: "./build",
      skip_codesigning: true,
      skip_package_ipa: true,
      skip_package_pkg: true
    )
    
    # æŸ¥æ‰¾æ„å»ºçš„ app
    app_path = Dir.glob("./build/**/Vibeviewer.app").first
    unless app_path
      UI.user_error!("Could not find built app")
    end
    
    # åˆ›å»º DMG
    version = get_version_from_project
    dmg_name = "Vibeviewer-#{version}-Debug.dmg"
    
    create_dmg(
      app_path: app_path,
      dmg_name: dmg_name,
      output_directory: "./build",
      background_image: File.exist?("dmg_background.png") ? "dmg_background.png" : nil
    )
    
    UI.success("Debug build completed: #{dmg_name}")
  end

  # Release Lane: å®Œæ•´å‘å¸ƒæµç¨‹
  lane :release do
    UI.header("Starting Release Process")
    
    # è·å–ç‰ˆæœ¬å·
    version = get_version_from_project
    tag_name = "v#{version}"
    github_repo = get_github_repo
    
    UI.message("Version: #{version}")
    UI.message("Tag: #{tag_name}")
    
    # ä½¿ç”¨ gym æ„å»ºåº”ç”¨
    UI.header("Building Release version")
    gym(
      workspace: "Vibeviewer.xcworkspace",
      scheme: "Vibeviewer",
      configuration: "Release",
      export_method: "app-store",
      output_directory: "./build",
      skip_codesigning: true,
      skip_package_ipa: true,
      skip_package_pkg: true
    )
    
    # æŸ¥æ‰¾æ„å»ºçš„ app
    app_path = Dir.glob("./build/**/Vibeviewer.app").first
    unless app_path
      UI.user_error!("Could not find built app")
    end
    
    # åˆ›å»º DMG
    UI.header("Creating DMG")
    dmg_name = "Vibeviewer-#{version}.dmg"
    
    create_dmg(
      app_path: app_path,
      dmg_name: dmg_name,
      output_directory: "./build",
      background_image: File.exist?("dmg_background.png") ? "dmg_background.png" : nil
    )
    
    dmg_path = lane_context[SharedValues::DMG_PATH]
    UI.success("DMG created: #{dmg_path}")
    
    # æ£€æŸ¥ Git çŠ¶æ€
    UI.header("Checking Git status")
    ensure_git_status_clean
    
    # åˆ›å»º Git tagï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    UI.header("Creating Git tag")
    begin
      sh("git", "rev-parse", "-#{tag_name}", ">/dev/null", "2>&1")
      UI.important("Tag #{tag_name} already exists")
      if UI.confirm("Do you want to delete and recreate it?")
        sh("git", "tag", "-d", tag_name)
        sh("git", "push", "origin", ":refs/tags/#{tag_name}", error_callback: proc { |result| })
        add_git_tag(tag: tag_name, message: "Release version #{version}")
      end
    rescue
      add_git_tag(tag: tag_name, message: "Release version #{version}")
    end
    
    # æ¨é€ tag
    push_git_tags
    
    # ç”Ÿæˆ appcast.xml
    UI.header("Generating appcast.xml")
    dmg_url = "https://github.com/#{github_repo}/releases/download/#{tag_name}/#{dmg_name}"
    release_notes_url = "https://github.com/#{github_repo}/releases/tag/#{tag_name}"
    
    sh("bash", "Scripts/generate_appcast.sh", version, dmg_url, release_notes_url, "appcast.xml")
    
    unless File.exist?("appcast.xml")
      UI.user_error!("Failed to generate appcast.xml")
    end
    
    # åˆ›å»ºæˆ–æ›´æ–° GitHub Release
    UI.header("Creating GitHub Release")
    github_token = ENV["GITHUB_TOKEN"]
    unless github_token
      UI.user_error!("GITHUB_TOKEN environment variable is required")
    end
    
    # è·å–å˜æ›´æ—¥å¿—
    prev_tag = ""
    begin
      prev_tag = sh("git", "describe", "--tags", "--abbrev=0", "HEAD~1").strip
    rescue
      prev_tag = ""
    end
    
    changelog = ""
    if prev_tag && !prev_tag.empty?
      begin
        changelog = sh("git", "log", "#{prev_tag}..HEAD", "--pretty=format:- %s").strip
      rescue
        changelog = ""
      end
    else
      begin
        changelog = sh("git", "log", "--oneline", "-10", "--pretty=format:- %s").strip
      rescue
        changelog = ""
      end
    end
    
    release_notes = <<~NOTES
      ## æ›´æ–°å†…å®¹
      
      #{changelog}
      
      ## æŠ€æœ¯æ”¹è¿›
      
      - ç‰ˆæœ¬æ›´æ–°è‡³ #{version}
      - ä¼˜åŒ–è‡ªåŠ¨æ›´æ–°æœºåˆ¶
    NOTES
    
    # æ£€æŸ¥ Release æ˜¯å¦å·²å­˜åœ¨
    release_exists = false
    begin
      response = github_api(
        server_url: "https://api.github.com",
        api_token: github_token,
        http_method: "GET",
        path: "/repos/#{github_repo}/releases/tags/#{tag_name}"
      )
      release_exists = true
      UI.important("Release #{tag_name} already exists")
      if UI.confirm("Do you want to delete and recreate it?")
        # è·å– release ID
        release_id = response[:id] || response["id"]
        if release_id
          # åˆ é™¤ç°æœ‰ Release
          github_api(
            server_url: "https://api.github.com",
            api_token: github_token,
            http_method: "DELETE",
            path: "/repos/#{github_repo}/releases/#{release_id}"
          )
        end
        # åˆ›å»ºæ–° Release
        create_github_release(
          api_token: github_token,
          repository_name: github_repo,
          name: "Version #{version}",
          tag_name: tag_name,
          description: release_notes,
          commitish: "main"
        )
      else
        # åªä¸Šä¼ æ–‡ä»¶
        UI.message("Uploading files to existing release")
      end
    rescue => e
      # Release ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°çš„
      create_github_release(
        api_token: github_token,
        repository_name: github_repo,
        name: "Version #{version}",
        tag_name: tag_name,
        description: release_notes,
        commitish: "main"
      )
    end
    
    # ä¸Šä¼  DMG æ–‡ä»¶
    UI.header("Uploading DMG to GitHub Release")
    upload_to_github_release(
      api_token: github_token,
      repository_name: github_repo,
      tag_name: tag_name,
      file_path: dmg_path,
      asset_name: dmg_name,
      asset_content_type: "application/octet-stream"
    )
    
    # ä¸Šä¼  appcast.xml
    UI.header("Uploading appcast.xml to GitHub Release")
    upload_to_github_release(
      api_token: github_token,
      repository_name: github_repo,
      tag_name: tag_name,
      file_path: "appcast.xml",
      asset_name: "appcast.xml",
      asset_content_type: "application/xml"
    )
    
    UI.success("ğŸ‰ Release completed successfully!")
    UI.message("Release URL: https://github.com/#{github_repo}/releases/tag/#{tag_name}")
  end
end

